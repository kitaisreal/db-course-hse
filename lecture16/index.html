<!DOCTYPE html>
<html lang="en">
<head>
    <title>HSE DB Course. Lecture 14.</title>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="shower/themes/yandex/styles/screen-16x9.css">

    <style type="text/css">
        code { display: block; white-space: pre; background-color: #EEE; }
        p.cloud { text-align: center; line-height: 1.5; }
        p.cloud span { font-size: 13pt; color: gray; padding: 0 20px 0 20px; white-space: nowrap; }
   </style>
</head>
<body class="shower list">
    <header class="caption">
        <h1>Базы данных 2022</h1>
    </header>

    <section class="slide" id="cover">
        <h1 style="margin-top: 150px;">Лекция 16. Transactions.</h1>
    </section>

    <section class="slide">
        <h2>План</h2>
        <p>1. Transactions Basics.</p>
        <p>2. Transactions Correctness.</p>
        <p>3. Transcations Serializability.</p>
    </section>

    <section class="slide">
        <h1>Transactions Basics</h1>

        <p>Транзакция — это выполнение последовательности одной или нескольких операций (например, SQL-запросов) в общей базе данных для выполнения какой-либо функции более высокого уровня.</p>
        <p>Они являются основной единицей работы в СУБД.</p>
        <p>Частичное выполнение транзакций не допускается.</p>
    </section>

    <section class="slide">
        <h1>Transactions Basics</h1>

        <p>Выполнение параллельных транзакций в СУБД является сложной задачей.</p>
        <p>Трудно обеспечить корректность транзакции при высокой конкуретности запросов.</p>
        <p>1. Временная неконсистентность в данных допустима.</p>
        <p>2. Полная неконсистентность в данных недопустима.</p>
    </section>

    <section class="slide">
        <h1>Transactions Basics</h1>

        <p>Объем транзакции находится только внутри базы данных.</p>
        <p>СУБД не может откатить side-effects транзакции в других приложениях.</p>
    </section>

    <section class="slide">
        <h1>Transactions Basics</h1>

        <p>Простой вариант обеспечить корректность это не выполнять транзакции конкурентно.</p>
        <p>В таком случае мы не утилизируем все ресурсы CPU, Memory, IO.</p>
    </section>

    <section class="slide">
        <h1>Transactions Basics</h1>

        <p>База данных представляет собой множество именованных объектов данных (A,B,C,..).</p>
        <p>Транзакция представляет собой последовательность операций чтения и записи (R(A), W(B)).</p>
        <p>Результатом транзакции является <b>COMMIT</b> или <b>ABORT</b>.</p>
        <p>1. Если результат COMMIT, все изменения транзакции сохраняются в базе данных или если была нарушена корректность (произошел конфликт) происходит откат.</p>
        <p>2. Если ABORT, все изменения транзакции откатываются, как если бы транзакция никогда не происходила.
            Откаты могут быть как самопроизвольными, так и вызванными СУБД.</p>
    </section>

    <section class="slide">
        <h1>Transactions Basics</h1>

        <p>Пример транзакции:</p>
        <p>BEGIN;</p>
        <p>SQL statements;</p>
        <p>COMMIT/ABORT</p>
    </section>

    <section class="slide">
        <h1>Transactions Correctness</h1>

        <p><b>ACID</b> критерии корректности транзакции:</p>
        <p>1. Атомарность (Atomicity) -  выполняются все действия в транзакции или не происходит ни одного.</p>
        <p>2. Консистентность (Consistency) - если каждая транзакция консистентна и база данных консистентна в начале транзакции,
            то гарантируется консистентна базы данных после завершения транзакции.</p>
        <p>3. Изоляция (Isolation) - выполнение одной транзакции изолировано от выполнения других транзакций.</p>
        <p>4. Долговечность (Durability): если транзакция фиксируется (<b>COMMIT</b>), ее изменения сохраняются в СУБД.</p>
    </section>

    <section class="slide">
        <h1>Transactions Atomicity</h1>

        <p>СУБД гарантирует атомарность транзакций. Транзакция либо выполняет все свои действия, либо ничего из них.</p>
        <p>Пример. Перевод с одного счета на другой счет какой то суммы.</p>
        <p>1. Сняли с 1 счета и произошел сбой.</p>
        <p>2. Сняли с 1 счета и произошел откат транзакции.</p>
    </section>

    <section class="slide">
        <h1>Transactions. Atomicity</h1>

        <p>Ведение журнала (Logging)</p>
        <p>СУБД регистрирует все действия, чтобы иметь возможность отменить действия прерванных транзакций.</p>
        <p>Ведение журналов используется всеми современными СУБД в целях аудита и повышения эффективности.</p>
    </section>

    <section class="slide">
        <h1>Transactions. Atomicity</h1>

        <p>Копирование страниц (Shadow Paging)</p>
        <p>1. СУБД создает копии страниц, а транзакции вносят изменения в эти копии. Только когда транзакция фиксируется, страница становится видимой для других.</p>
    </section>

    <section class="slide">
        <h1>Transactions. Consistency</h1>

        <p>Данные в СУБД непротиворечивы</p>
        <p>1. Консистетность СУБД (Обязанность СУБД):</p>
        <p>Удовлетворяют внутренним ограничениям целостности (internal constraints) и внешним ограничениям целостности (referential constraints).</p>
        <p>2. Консистетность транзакций (Обязанность приложения):</p>
        <p>Если СУБД консистентная до применения транзакции, то после применения транзакции остается консистетностой.</p>
    </section>

    <section class="slide">
        <h1>Transactions. Isolation</h1>

        <p>Для транзакции создается эффект что она выполняется в системе одна, side-effects других транзакций не видны.</p>
        <p>Это эквивалентно системе, в которой транзакции выполняются в последовательном порядке (по одной за раз).</p>
        <p>Для повышения производительности СУБД приходится чередовать операции параллельных транзакций.</p>
    </section>

    <section class="slide">
        <h1>Transactions. Concurrency Control</h1>

        <p>Протокол управления параллелизмом — это то, как СУБД определяет правильное чередование операций из нескольких транзакций.</p>
        <p>Существует две категории протоколов управления параллелизмом:</p>
        <p>1. Пессимистичный (Pessimistic): СУБД предполагает, что транзакции будут конфликтовать, поэтому она не допускает возникновения проблем.</p>
        <p>2. Оптимистичный (Optimistic): СУБД исходит из того, что конфликты между транзакциями случаются редко, поэтому разрешение конфликтов происходит только когда они случаются.</p>
    </section>

    <section class="slide">
        <h1>Transactions. Concurrency Control</h1>

        <p>Порядок, в котором СУБД выполняет операции, называется расписанием выполнения (Schedule).</p>
        <p>Целью протокола управления параллелизмом является создание расписания выполнения, эквивалентного некоторому последовательному выполнению транзакций.</p>
    </section>

    <section class="slide">
        <h1>Transactions. Concurrency Control</h1>

        <p>Примеры расписаний:</p>
        <p>Последовательное расписание (Serial Schedule): расписание, в котором не чередуются действия различных транзакций (корректно по определению).</p>
        <p>Эквивалентные расписания (Equivalent Schedules): для любого состояния базы данных эффект выполнения первого расписания идентичен эффект выполнения второго расписания.</p>
        <p>Сериализуемое расписание (Serializable Schedule): расписание, эквивалентное некоторому последовательному расписанию.</p>
    </section>

    <section class="slide">
        <h1>Transactions. Concurrency Control</h1>

        <p>Когда СУБД чередует операции параллельных транзакций, она может создавать аномалии:</p>
        <p>Конфликты чтения-записи (Unrepeatable Reads): транзакция не может получить одно и то же значение при многократном чтении одного и того же объекта.</p>
        <p>Конфликты записи-чтения (Dirty Reads): транзакция видит последствия записи другой транзакции до того, как эта транзакция зафиксировала свои изменения.</p>
        <p>Конфликт записи-записи (Lost Updates): одна транзакция перезаписывает незафиксированные данные другой параллельной транзакции.</p>
    </section>

    <section class="slide">
        <h1>Transactions. Concurrency Control</h1>

        <p>Корректное расписание операций эквивалетно любому последовательному расписанию (Serializable Schedule).</p>

        <p>Существуют разные уровни сериализуемости:</p>
        <p>Конфликтная серализуемость (Conflict Serializability). Большинство СУБД стараются это поддерживать.</p>
        <p>View serializability. СУБД не могут это поддержать, так как необходимо поддерживать учитывать конкурентные транзакции.</p>
    </section>

    <section class="slide">
        <h1>Transactions. Conflict Serializability</h1>

        <p>Конфликтная серализуемые расписания эквивалентны некоторым последовательным расписаниям.</p>
        <p>Это то, что поддерживает каждая СУБД, которая поддерживает уровень изоляции <b>SERIALIZABLE</b>.</p>
        <p>Расписание <b>S</b> конфликтно-сериализуемо, если вы можете преобразовать <b>S</b> в последовательное расписание,
            поменяв местами последовательные неконфликтующие операции различных транзакций.</p>
    </section>

    <section class="slide">
        <h1>Transactions. Dependency Graph</h1>

        <p>Граф зависимостей (Dependency Graph, Precedence Graph):</p>
        <p>Узел в графе транзакция (Ti).</p>
        <p>Переход от Ti к Tj, если операция Oi из Ti конфликтует с операцией Oj из Tj и Oi появляется раньше в расписании, чем Oj.</p>
        <p>Расписание конфликтно сериализуемо тогда и только тогда, когда его граф зависимостей ацикличен.</p>
    </section>

    <section class="slide">
        <h1>Transactions. Durability</h1>

        <p>Все изменения зафиксированных транзакций должны быть устойчивыми (т. е. постоянными) после сбоя или перезапуска.</p>
        <p>Большинство СУБД используют ведение журнала (WAL) чтобы обеспечить устойчивость всех изменений.</p>
    </section>

    <section class="slide">
        <h1>Conclusion</h1>

        <p>Транзакции и восстановление после сбоев одними из наиболее важных функций, предоставляемых СУБД.</p>
        <p>СУБД необходимо выполнять транзакции конкурентно для улучшения утилизации CPU, Memory, IO.</p>
        <p>СУБД может допускать различные аномалии для увеличения производительности.</p>
    </section>

    <section class="slide">
        <h1>Questions ?</h1>
    </section>

    <div class="progress"></div>
    <script src="shower/shower.min.js"></script>

    <!--Video plugin-->
    <link rel="stylesheet" href="shower/shower-video.css">
    <script src="shower/shower-video.js"></script>
    <!--/Video plugin-->
</body>
</html>
